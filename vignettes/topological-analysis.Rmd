---
title: "Topological Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Topological Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(robber)
library(ggplot2)
library(dplyr)
library(purrr)
library(tidyr)
library(tibble)
```

In what follows, we will use \code{robber} to illustrate how different 
set of parameters of block models, representing differents topologies of 
network has an influence on the robustness of bipartite ecological networks.

We will compare set of networks that all have the same number of rows,
columns and density. We select those numbers such that the maximum number for
the robustness with uniform extinctions is approximately 0.5.

```{r set_constant}
dens <- .0156
nr <-  100
nc <- 100
rob_er <- auc_robustness_lbm(matrix(dens, 1,1), 1, 1, nr, nc)
rob_er
```

Robber compute the robustness as the AUC of the robustness function integrated over
all possible networks which arise from the same set of Block Model parameters.
For example using the above parameters of a network with not particular structure,
the black line is the average of all the dashed line which are the robustness function
of particular realization of networks issued from the same distribution:

```{r}
rob_fun <- lapply(
  X = seq_len(10),
  FUN = function(i) {
    A <- simulate_lbm(con = matrix(dens, 1, 1), 
                      pi = 1, 
                      rho = 1, 
                      nr = nr, 
                      nc = nc)$A
    robustness_emp(A)$fun
  }
)
bind_cols(rob_fun) %>% 
  mutate(`Primary Extinctions` = seq.int(0, nr)/nr) %>% 
  pivot_longer(cols = - `Primary Extinctions`,
               names_to = "Net",
               values_to = "Robustness") %>% 
  ggplot(aes(`Primary Extinctions`, Robustness, col = Net)) +
  geom_step(linetype = "dashed", show.legend = FALSE) +
  annotate("step", x = seq.int(0, nr)/nr, 
           y = robustness_lbm(matrix(dens, 1,1), 1, 1, nr, nc)$fun,
           size = 2) +
  theme_minimal(base_size = 15)

# ggsave("rob_function.png", path = "~/Documents/robustness/robustness/image/",
       # width = 6, height = 4)
```



```{r echo=FALSE}
mod <- matrix(c("a", 1, 1, "a"), 2, 2)
cp  <- matrix(c("a", "a", "a", 1), 2, 2)
```

We will consider 2 blocks of row species and 2 blocks of column species. 
The parameters will be as followed:

* $\pi$ The row blocks parameter will be set to [1/4, 3/4]
    
* $\rho$ The column blocks parameter will vary
    
* **con** The connectivity parameters between blocks will be set to 
    represent 2 classic topologies: 
    
    + __Modular__ the shape of the connectivity matrix will be as follows:
   
```{r echo=FALSE}
     knitr::kable(mod)
```

*     
    + __Nested__ A classic Core-periphery with or without strong connection
        between the core and the periphery depending on the parameters:

```{r echo=FALSE}
     knitr::kable(cp)
``` 

```{r parameters}
pi <- c(1/4, 3/4)
```


```{r analyse_article}
robust_topology <- tibble::tibble()
eps <- c(1/seq(8, 1.5, by = -.5), seq(1, 8, by = .5))
for(i in seq(19)) {
  rho <- c(i*.05, (20-i)*.05)
  list_con_mod <- lapply( eps,
                          function(j) {
                            list(con = matrix(c(j, 1,
                                                1, j), 2, 2),
                                 pi = pi,
                                 rho = rho)})
  rob_mod <- purrr::map_dfc(
    .x = purrr::set_names(c("uniform", "increasing", "decreasing")), 
    .f = function(x) 
      unlist(compare_robustness(list_param = list_con_mod, 
                                dens = dens, 
                                new_nr = nr, 
                                new_nc = nc, 
                                ext_seq = x))) %>%  
    dplyr::mutate(Topology = "Modular", 
                  rho = rho[1], 
                  j = seq_along(eps))
  list_con_nest <- lapply( eps,
                           function(j) {
                             list(con = matrix(c(j, j,
                                                 j, 1), 2, 2),
                                  pi = pi,
                                  rho = rho)})
  rob_nest <- purrr::map_dfc(.x = purrr::set_names(c("uniform", "increasing", "decreasing")), 
                             .f = function(x) 
                               unlist(compare_robustness(list_param = list_con_nest, 
                                                         dens = dens, 
                                                         new_nr = nr, 
                                                         new_nc = nc, 
                                                         ext_seq = x))) %>%  
    dplyr::mutate(Topology = "Nested", 
                  rho = rho[1], 
                  j = seq_along(eps))
  robust_topology <- dplyr::bind_rows(robust_topology, rob_mod, rob_nest)
}
```



```{r print_article}
robust_topology %>%
  tidyr::pivot_longer(cols = c("uniform", "increasing", "decreasing"), 
                      names_to = "Extinction", 
                      values_to = "Robustness") %>%
  ggplot2::ggplot(ggplot2::aes(x = j, y = rho)) +
  ggplot2::geom_tile(ggplot2::aes(fill = Robustness)) +
  ggplot2::facet_grid(Topology  ~ Extinction) +
  ggplot2::scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                                midpoint = rob_er, 
                                ggplot2::guide_colorbar(title = "AUC(R)")) +
  ggplot2::annotate(x = 15, y = .5, geom = "point", col = "black", size = 3) +
  ggplot2::annotate(x = 15, y = .55, geom = "text", label = "ER",
                    col = "black", size = 3) +
  ggplot2::scale_x_continuous(breaks = c(0, 7, 15, 22, 30), 
                              labels = c(1/8, 1/4, 1, 4, 8)) +
  ggplot2::coord_fixed(ratio = 30) +
  ggplot2::theme_classic(base_size = 15)
# ggsave(filename = "robust_topology_heatmap.png",  path = "~/Documents/robustness/robustness/image/", height = 6, width = 9)
```


## Testing the variance of the MC robustness and the LBM robustness from simulated LBM networks

```{r compute_gnp}
if (! file.exists("res_gnp.rds")) {
n_iter <- 300
pi <- c(.1,.9)
rho <- c(.2,.8)
con <- matrix(c(.8, .4, .4, .1), 2, 2)
con <- 0.1*con/as.vector(pi%*%con%*%rho)
nr <- 100
nc <- 100
res <- pbmcapply::pbmclapply(
  X = seq(500),
  FUN = function(i) {
    G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con)
    auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
    par <- get_lbm_param(G$A)
    auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
    return(tibble(type = "cp", mc = auc_mc, lbm = auc_lbm ))
  }, mc.cores = 8
)
res_cp <- bind_rows(res)

n_iter <- 300
pi <- 1
rho <- 1
con <- matrix(0.1, 1, 1)
nr <- 100
nc <- 100
res <- pbmcapply::pbmclapply(
  X = seq(500),
  FUN = function(i) {
    G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con)
    auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
    par <- get_lbm_param(G$A)
    auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
    return(tibble(type = "er", mc = auc_mc, lbm = auc_lbm ))
  }, mc.cores = 8
)
res_er <- bind_rows(res)

pi  <- c(.2, .8)
rho <- c(.9, .1)
con <- matrix(c(.6, .1, .2, .2), 2, 2)
con <- 0.1*con/as.vector(pi%*%con%*%rho)
res <- pbmcapply::pbmclapply(
  X = seq(500),
  FUN = function(i) {
    G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con)
    auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
    par <- get_lbm_param(G$A)
    auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
    return(tibble(type = "mod", mc = auc_mc, lbm = auc_lbm ))
  }, mc.cores = 8
)
res_mod <- bind_rows(res)
  res_gnp <- bind_rows(res_cp, res_mod, res_er)
  saveRDS(res_gnp, "res_gnp.rds")
} else {
  res_gnp <- readRDS("res_gnp.rds")
}
```

```{r}
res_gnp %>% 
  pivot_longer(cols = - type, names_to = "Method", values_to = "Robustness") %>% 
  filter(Method == "mc") %>% 
  ggplot(aes(x = Robustness, fill = type)) +
  geom_density(alpha = .2) +
  ylab(label = "") +
#  geom_vline(xintercept =  robustness_lbm(con, pi, rho, nr, nc)$auc) +
  theme_minimal(base_size = 15)
```
```{r compute_gnm}
if (! file.exists("res_gnm.rds")) {
  n_iter <- 300
  nr <- 100
  nc <- 100
  
  pi <- c(.1,.9)
  rho <- c(.2,.8)
  con <- matrix(c(.8, .4, .4, .1), 2, 2)
  con <- 0.1*con/as.vector(pi%*%con%*%rho)
  pi <- nr * pi
  rho <- nc * rho
  con <- round(outer(pi, rho) * con)
  
  res <- pbmcapply::pbmclapply(
    X = seq(500),
    FUN = function(i) {
      G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con, method = "gnm")
      auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
      par <- get_lbm_param(G$A)
      auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
      return(tibble(type = "cp", mc = auc_mc, lbm = auc_lbm ))
    }, mc.cores = 8
  )
  res_cp_gnm <- bind_rows(res)
  
  pi <- 1
  rho <- 1
  con <- matrix(0.1, 1, 1)
  pi <- nr * pi
  rho <- nc * rho
  con <- round(outer(pi, rho) * con)
  res <- pbmcapply::pbmclapply(
    X = seq(500),
    FUN = function(i) {
      G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con, method = "gnm")
      auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
      par <- get_lbm_param(G$A)
      auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
      return(tibble(type = "er", mc = auc_mc, lbm = auc_lbm ))
    }, mc.cores = 8
  )
  res_er_gnm <- bind_rows(res)
  
  pi  <- c(.2, .8)
  rho <- c(.9, .1)
  con <- matrix(c(.6, .1, .2, .2), 2, 2)
  con <- 0.1*con/as.vector(pi%*%con%*%rho)
  pi <- nr * pi
  rho <- nc * rho
  con <- round(outer(pi, rho) * con)
  res <- pbmcapply::pbmclapply(
    X = seq(500),
    FUN = function(i) {
      G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con, method = "gnm")
      auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc
      par <- get_lbm_param(G$A)
      auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
      return(tibble(type = "mod", mc = auc_mc, lbm = auc_lbm ))
    }, mc.cores = 8
  )
  res_mod_gnm <- bind_rows(res)  
  res_gnm <- bind_rows(res_cp_gnm, res_mod_gnm, res_er_gnm)
  saveRDS(res_gnm, "res_gnm.rds")
} else {
  res_gnm <- readRDS("res_gnm.rds")
}

```


```{r}
pi <- c(.1,.9)
rho <- c(.2,.8)
con <- matrix(c(.8, .4, .4, .1), 2, 2)
con <- 0.1*con/as.vector(pi%*%con%*%rho)
var_auc_unif_lbm(con, pi, rho, nr, nc)
```
```{r}
res_gnm %>% 
  pivot_longer(cols = - type, names_to = "Method", values_to = "Robustness") %>% 
  filter(Method == "mc") %>% 
  ggplot(aes(x = Robustness, fill = type)) +
  geom_density(alpha = .2) #+
 # geom_vline(xintercept =  robustness_lbm(con, pi, rho, nr, nc)$auc)
```
```{r}
res_gnm %>% 
  mutate(Model = "Microcanonical") %>% 
  bind_rows(
      res_gnp %>% 
      mutate(Model = "Canonical")) %>% 
  pivot_longer(cols = - c(type, Model), names_to = "Method", values_to = "Robustness") %>% 
#  rename(Topology = type) %>% 
  mutate(
    Topology = case_when(
      type == "cp" ~ "Nested",
      type == "er" ~ "ER",
      type == "mod" ~ "Modular"
    )) %>% 
  filter(Method == "mc") %>% 
  ggplot(aes(x = Robustness, fill = Topology, lty = Topology)) +
  geom_density(alpha = .2) +
  ylab(label = "") +
  facet_wrap(~ Model) +
  theme_bw(base_size = 15)
# ggsave(filename = "variance_density.png", path = "~/Documents/robustness/robustness/image/",
       # width = 8, height = 4.5)
```

```{r}
n_iter <- 300
con <- matrix(c(.99, .3, .01, .4), 2, 2)
pi <- rho <- c(.5, .5)
#con <- 0.1*con/as.vector(pi%*%con%*%rho)
nr <- nc <- 50
res <- pbmcapply::pbmclapply(
  X = seq(100),
  FUN = function(i) {
    G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con)
    unif_mc <- robustness_emp(G$A, nb_iter =  n_iter, ext_seq = "uniform")$auc
    dec_mc <- robustness_emp(G$A, nb_iter =  n_iter, ext_seq = "decreasing")$auc
    inc_mc <- robustness_emp(G$A, nb_iter =  n_iter, ext_seq = "increasing")$auc
    par <- get_lbm_param(G$A)
    unif_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc
    dec_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc, ext_seq = "decreasing")$auc
    inc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc, ext_seq = "increasing")$auc
    return(tibble(type = "strange", unif_mc = unif_mc, dec_mc = dec_mc, inc_mc = inc_mc,
                  unif_lbm = unif_lbm, dec_lbm = dec_lbm, inc_lbm = inc_lbm))
  }, mc.cores = 8
)
res_strange <- bind_rows(res)
```

```{r}
robustness_lbm(con, pi, rho, nr, nc)$auc
robustness_lbm(con, pi, rho, nr, nc, ext_seq = "increasing")$auc
robustness_lbm(con, pi, rho, nr, nc, ext_seq = "decreasing")$auc
```
```{r}
con <- matrix(c(.5, .2, .01, .3), 2, 2)
pi <- c(.2, .8)
rho <- c(.5, .5)
robustness_lbm(con, pi, rho, nr, nc)$auc
robustness_lbm(con, pi, rho, nr, nc, ext_seq = "increasing")$auc
robustness_lbm(con, pi, rho, nr, nc, ext_seq = "decreasing")$auc
```


```{r}
skimr::skim(res_strange)
res_strange %>% 
  pivot_longer(cols = where(is.numeric), names_to = "Method", values_to = "Robustness") %>% 
  # mutate(
  #   Extinction = case_when(
  #     Method == "unif" ~ "Uniform",
  #     Method == "inc" ~ "Increasing",
  #     Method == "dec" ~ "Decreasing"
  #   )) %>% 
  ggplot(aes(x = Robustness, fill = Method, linetype = Method)) +
  geom_density(alpha = .2) +
  ylab(label = "") +
#  facet_wrap(~ Model) +
  theme_bw(base_size = 15)
```











```{r}
bind_rows(res_cp_gnm, res_mod_gnm, res_er_gnm) %>% 
  mutate(Model = "Microcanonical") %>% 
  bind_rows(
    bind_rows(res_cp, res_mod, res_er) %>% 
      mutate(Model = "Canonical")) %>% 
  pivot_longer(cols = - c(type, Model), names_to = "Method", values_to = "Robustness") %>% 
  group_by(type, Model, Method) %>% 
  summarise(mean(Robustness))
```

<!-- Normalite asymptotique : -->
<!-- ```{r} -->
<!-- #n_iter <- 300 -->
<!-- pi <- c(.2,.8) -->
<!-- rho <- c(.2,.8) -->
<!-- con <- matrix(c(.8, .4, .4, .1), 2, 2) -->
<!-- con <- 0.03*con/as.vector(pi%*%con%*%rho) -->
<!-- nr <- 800 -->
<!-- nc <- 250 -->
<!-- res <- pbmcapply::pbmclapply( -->
<!--   X = seq(1000), -->
<!--   FUN = function(i) { -->
<!--     G <- simulate_lbm(nr = nr, nc = nc, pi = pi, rho = rho, con = con) -->
<!-- #    auc_mc <- robustness_emp(G$A, nb_iter =  n_iter)$auc -->
<!--     par <- get_lbm_param(G$A) -->
<!--     auc_lbm <- robustness_lbm(par$con, par$pi, par$rho, nr, nc)$auc -->
<!--     auc_dec <- robustness_lbm(par$con, par$pi, par$rho, nr, nc, ext_seq = "decreasing")$auc -->
<!--     return(tibble(type = "cp", dec = auc_dec, lbm = auc_lbm )) -->
<!--   }, mc.cores = 8 -->
<!-- ) -->
<!-- res_an <- bind_rows(res) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- bind_rows(res_an) %>%  -->
<!--   pivot_longer(cols = - type, names_to = "Method", values_to = "Robustness") %>%  -->
<!-- #  filter(Method == "mc") %>%  -->
<!--   ggplot(aes(x = Robustness, fill = Method)) + -->
<!--   geom_density(alpha = .2) #+ -->
<!-- ``` -->
